# 20 明文密码

### 笔记

---

#### 目标: 恢复或重置密码

#### 反模式: 使用明文存储密码

##### 存储密码

使用明文存储密码或者使用明文在网络上传递密码都是不安全的.

* 在客户端和服务器端数据库交互的网路线路上截获数据包.
* 在数据库服务器上搜索`SQL`的查询日志.
* 从服务器或者备份介质上读取数据库备份文件的内数据.

##### 验证密码

密码比较只能以明文字符串的形式进行.

```sql
SELECR CASE WHEN password = 'opensesame' THEN 1 ELSE 0 END
AS password_matches
FROM Accounts
WHERE account_id = 123
```

如果用户输入的密码是错的, 因此整个查询返回了`0`.

**别把两个不同的候选项绑在一起**

```sql
SELECT * FROM Accounts WHERE account_name = 'bill' AND password = 'opensesame';
```

如果不正确, 不能区分到底是用户名错误还是密码错误.

##### 在E-mail中发送密码

将明文密码通过邮件发送是非常严重的安全隐患.

E-mail安全协议的覆盖面并不足够广, E-mail的手法都需要经由网络层传输, 数据可能会在其他的路由节点上被截获.

#### 如何识别反模式

按需设置安全级别.

#### 解决方案: 先哈希, 后存储

##### 理解哈希函数

==哈希==是指将输入字符串转化成另一个新的, 不可识别的字符串的函数.

哈希的另一个特征就是不可逆. 哈希函数的算法设计就是要"丢失"一些输入串的信息, 所以无法从一个哈希串会付出原始输入串.

##### 在SQL中使用哈希

`Mysql`的`SSL`扩展支持包含了`SHA2()`的函数.

比较密码时使用两个哈希后的值进行比较.

锁定用户的时候也可以简单的将用户的密码改成一个不可能哈希函数的到的字符串将其锁住(比如`md5`我们把密码改为111, 则任何数字的`md5`都不可能得到111).

##### 给哈希加料

在将用户密码传入哈希函数进行加密之前, 将其和一个无意义的串拼接在一起, 即使用户选择了一个在字典中存在的单词作为密码, 也得不到这个杂质(盐).

##### 在SQL中隐藏密码

在`SQL`查询中使用哈希串, 即使攻击者截获了数据包, 也没办法将哈希反转成它所需要的密码.

在浏览器和服务器之间使用`https`链接.

##### 重置密码, 而非恢复密码

**方案1 (邮件显示临时密码)**

用户忘记他们的密码请求帮助的时候, 程序发送一封带有临时生成密码的邮件给用户, 而不是直接发给他自己的密码. 在一个较短时间之内, 这个临时密码就会过期. 同时, 程序应该设计成一旦用户使用临时密码登陆后, 就应该被强制要求修改密码.

**方案2 (邮件链接带一个token用于验证)**

在数据库中记录下这个请求, 并且为其分配一个唯一的令牌作为标识, 而不是发送带有新密码的邮件.

在E-mail中包含这个令牌, 或者使用短信. 给令牌加上过期时间, 用于增加安全性.

### 整理知识点

---