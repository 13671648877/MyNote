# 18 意大利面条式查询

### 笔记

---

#### 目标: 减少SQL查询数量

开发人员经常会被同一个问题困扰:"==我要怎么用一个查询来完成这件事情==".

#### 反模式: 使用异步操作解决复杂问题

==SQL是一门极具表现力的语言 -- 你可以在单个`SQL`查询或者单条语句中完成单条语句中完成很多事情. 但这并不意味着必须强制只使用一行代码, 或者认为使用一行代码就搞定每个任务是个好主意. 你在使用其他语言的时候也有这样的习惯? 应该没有吧.==

##### 副作用

通过一个查询来获得所有结果的常见后果就是得到了一个**笛卡尔**积.

```
笛卡尔乘积是指在数学中，两个集合X和Y的笛卡尓积(Cartesian product),又称直积,表示为X × Y,第一个对象是X的成员而第二个对象是Y的所有可能有序对的其中一个成员.
```

##### 那好像还不够

这些查询:

* 非常难写
* 难以修改
* 难以调试

一条精心设计的复杂`SQL`查询, 相比于那些直接简单的查询来说, 不得不使用很多的`JOIN`, 关联子查询和其他让`SQL`引擎难以优化和快速执行的操作符.

一个怪兽般的`SQL`查询的开销可能成指数级别增长, 而使用多个简单的查询却有更好的效果.

#### 如何识别反模式

* 为什么我的求和, 技术返回的结果异常大?
* 我一整天都在和这个变态的查询语句做斗争.
* 我们不能在数据库报表中再加入任何新东西了, 因为对查询语句的修改要花很长时间.
* 试试看再加一个`DISTINCT`进去?


考虑到可能在某个`SQL`语句中做了太多事情.

#### 合理使用反模式

需要将一个复杂的查询任务放在一个`SQL`查询中完成的最常见原因， 是正在使用一个编程框架或一个可视化组件库直接和数据源相连.

#### 解决方案分而治之

**简约律**

当你有两个相互竞争的理论能得出同样的结论, 那么简单的那个更好.

##### 一步一个脚印

要避免生成这个笛卡尔积, 你不得不将这个意大利面条式查询拆分成几个小而简单的查询.

**使用多条简单的sql语句代替一条复杂sql语句的优点**

* 当有新的需求增加到报表时, 添加另一个简单的查询, 必将更多的计算整合到一个已经很复杂的查询中去要简单很多.
* `SQL`引擎能更容易和可靠地对简单的查询进行优化和执行. 即使整个工作看上去像是被分割出来的查询弄得有点重复, 但可能执行得更快.
* 在代码审查或者团队间的培训交流时, 解释几个易懂的查询要比解释一个庞大复杂的查询容易得多.

##### 寻找`UNION`标记

可以将几个查询的结果进行`UNION`操作, 从而最终得到一个结果集.

仅在两个子查询的列属性是相互兼容的情况下才能使用`UNION`. 不能再查询的中间改变列的数值, 名字或者数据类型, 因此需要确保所有行的所有列都是相同的.

#### 结论

执行多次`SQL`查询或者多条`SQL`语句可能并不是解决问题最高效的办法, 但你应该在效率和解决问题之间找到平衡点.

### 整理知识点

---