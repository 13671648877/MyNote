# 12 幽灵文件

### 笔记

---

#### 目标: 存储图片或其他多媒体文件

目标就是要存储这些图片并且将其和数据库实体关联起来. 当查询这些实体时, 我们需要确保同时能获取与其关联的图片.

##### 反模式: 假设你必须使用文件系统

将文件存在数据库之外. *这个也是我常用的解决方案*

##### 文件不支持 DELETE

删除图片的数据库数据记录的时候, 没有办法同时移除文件.

##### 文件不支持事务隔离

对于其他的客户端来说就立刻无法访问该图片了. 如果你改变了文件的内容, 其他的客户端可以立刻看到这些变更, 而不是看到在事务未提交之前的文件状态.

##### 文件不支持回滚操作

删除了数据, 但是文件不能回滚.

##### 文件不支持数据库备份工具

只能备份数据文件, 不同同步备份图片文件

##### 不支持`SQL`的访问权限设置

##### 文件不是`SQL`数据类型

将字符串作为路径处理的逻辑只能依赖于程序逻辑. 数据库只会认为是一个`string`而不会知道是一个`路径`或者`图片`.

#### 如何识别反模式

* 数据备份和恢复的过程是怎样的? 怎么对一个备份进行验证? 你有没有在一个干净的系统或者在别的系统上对备份回复的数据进行测试.
* 图片文件堆积在那里, 还是当它们鼓励的时候从系统中移除? 移除它们的过程是怎样的? 这是一个自动还是手动的过程?
* 系统中的哪些用户有权限查看这些图片? 进入权限是怎么限制的? 当用户请求看它们无权查看的图片时会发生什么?
* 我能成效对图片的变更吗? 如果能 是应用程序来负责回复图片之前的状态码?

#### 合理使用反模式

* 图片相比于简单的数据类型(比如整形和字符串)来说更大.
* 当不包含图片时备份数据库会更快并且备份文件更小.
* 如果图片是存储在数据库之外的文件系统, 对图片处理会更简单.

#### 解决方案: 在需要时使用`BLOB`类型

**文件->BLOB**

`Mysql`有个函数`LOAD_FILE()`, 读取一个文件, 然后将内容存到`BLOB`列中.

```sql
UPDATE screenshots
SET screenshot_image = LOAD_FILE(`images/xxx.jpg`)
WHERE xxx
```

**BLOG->文件**

```sql
SELECT screenshot_image
INTO DUMPFILE `images/xxx.jpg`
FROM screenshots
WHERE xxxx
```

### 整理知识点

---