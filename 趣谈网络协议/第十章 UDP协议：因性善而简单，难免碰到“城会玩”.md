# 第十章 UDP协议：因性善而简单，难免碰到“城会玩”

## 知识点

### TCP 和 UDP 区别

TCP是面向连接的.

#### 面向连接

在互通之前, 面向连接的协议会先**建立连接**.`TCP`会三次握手, `UDP`不会.

#### 建立连接

是为了在客户端和服务端维护连接, 而**建立一定的数据结构来维护双方交互的状态, 用这样的数据结构来保证所谓的面向连接的特性**.

#### 可靠性

* TCP提供可靠交付, 通过`TCP`连接传输的数据，无差错、不丢失、不重复、并且按序到达。
* `IP`包没有任何可靠性。`UDP`继承了`IP`包的特性, 不保证不丢失, 不保证按顺序到达。

#### 传输

* `TCP`是面向字节流的。发送的时候发的是一个流，没头没尾。IP 包可不是一个流，而是一个个的`IP`包。之所以变成了流, 这也是`TCP`自己的状态维护做的事情。
* `UDP`继承了`IP`的特性, 基于数据报的, 一个一个地发, 一个一个地收。

#### 拥塞控制

* `TCP`是可以拥塞控制的。它意识到包丢弃了或者网络的环境不好了，就会根据情况调整自己的行为，看看是不是发快了，要不要发慢点。
* `UDP`应用让我发，我就发，管它洪水滔天。

#### 有状态服务

* `TCP`其实是一个有状态服务。精确地记着发送了没有，接收到没有，发送到哪个了，应该接收哪个了，错一点儿都不行。
* `UDP`是无状态服务, 发出去就发出去了。

#### 总结

`MAC`层定义了本地局域网的传输行为,`IP`层定义了整个网络端到端的传输行为，这两层基本定义了这样的基因:

* **网络传输**是以**包**为单位的。
	* 二次传输叫**帧**。
	* 网络层叫**包**。
	* 传输层叫**段**。

我们笼统的称为包。包单独传输，自行选路，在不同的设备封装解封装，不保证到达。`UDP`完全继承了这些特性，几乎没有自己的思想。

### UDP包头是什么样的

`IP`头里面有个8为协议, 里面会存放, 数据里面到底是`TCP`还是`UDP`。

处理完**传输层**的事情, **内核的事情基本就干完了**, 里面的数据应该交给应用程序自己去处理。

交给哪个应用程序?

应用程序都要监听一个端口。正式这个端口, 用来区分用用程序。**根据端口号, 将数据交给响应的应用程序**。

![UDP包头](./img/10_01.jpg)

### UDP的三大特点

* 沟通简单, 没有复杂的数据结构, 处理逻辑, 包头字段. 相信网络通路默认就是很容易送达的，不容易被丢弃的。
* 轻信他人, 它不会建立连接，虽然有端口号，但是监听在这个地方，谁都可以传给他数据，他也可以传给任何人数据，甚至可以同时传给多个人数据。
* 愣头青, 做事不懂权变。它不会根据网络的情况进行发包的拥塞控制，无论网络丢包丢成啥样了，它该怎么发还怎么发。

### UDP的三大使用场景

* 需要资源少，在网络情况比较好的内网，或者对于丢包不敏感的应用。
	* `DHCP`就是基于`UDP`协议的(广播形式)。一般的获取 IP 地址都是内网请求，而且一次获取不到 IP 又没事，过一会儿还有机会。
	* `PXE`操作系统镜像的下载使用的`TFTP`，这个也是基于 UDP 协议。
* 不需要一对一沟通，建立连接，而是可以广播的应用。
	* `UDP`不面向连接, 使得可以继承广播或多播协议。
	* `D`类地址(组播地址), 使用这个地址, 可以将包组播给一批机器。当一台机器上的某个进程想监听某个组播地址的时候，需要发送 IGMP 包，所在网络的路由器就能收到这个包，知道有个机器上有个进程在监听这个组播地址。当路由器收到这个组播地址的时候，会将包转发给这台机器，这样就实现了跨路由器的组播。
* 需要处理速度快，时延低，可以容忍少数丢包，但是要求即便网络拥塞，也毫不退缩，一往无前的时候。'


#### 总结

如果实现的应用需要有自己的连接策略, 可靠保证, 时延要求, 使用`UDP`, 然后在应用层实现这些是再好不过了。

### UDP使用的五个例子

#### 网页或者APP的访问

HTTP 协议是基于 TCP 的，建立连接都需要多次交互，对于时延比较大的目前主流的移动互联网来讲，建立一次连接需要的时间会比较长，然而既然是移动中，TCP 可能还会断了重连，也是很耗时的。而且目前的 HTTP 协议，往往采取多个数据通道共享一个连接的情况，这样本来为了加快传输速度，但是 TCP 的严格顺序策略使得哪怕共享通道，前一个不来，后一个和前一个即便没关系，也要等着，时延也会加大。

`QUIC`（全称Quick UDP Internet Connections，快速 UDP 互联网连接）是`Google`提出的一种基于`UDP`改进的通信协议, 目的是降低网络通信的延迟, 提供更好的用户互动体验。

#### 流媒体协议

直播协议多使用`RTMP`。 `RTMP`协议也是基于`TCP`的。

很多直播应用，都基于`UDP`实现了自己的视频传输协议。

网络层不好, 应用选择性丢帧。

#### 实时游戏

在异步`IO`机制引入之前, `UDP`尝尝是应对海量客户端链接的策略。

游戏对实时要求较为严格的情况下，采用自定义的可靠 UDP 协议，自定义重传策略，能够把丢包产生的延迟降到最低，尽量减少网络问题对游戏性造成的影响。

#### IoT 物联网

物联网领域终端资源少, 维护`TCP`协议代价太大. 物联网对实时性要求也很高.

`Google`腿穿的物联网通信协议`Thread`就是基于`UDP`协议的。

#### 移动通信领域

在`4G`王国利, 移动流量上网的数据面对的协议`GTP-U`是基于`UDP`的。`GTP`协议本身就包含复杂的手机上线下线的通信协议。

### 小结

* `TCP`
	* 复杂
	* 维护连接
	* 知进退
* `UDP`
	* 简单
	* 谁都相信
	* 勇往直前

* `UDP`应用
	* 环境简单
	* 需要多播
	* 应用层自己控制传输

## 知识点扩展