#17_03_sudo详解

---

####用户只有两类

管理员 和 普通用户

####sudo

**su**

switch user

**sudo**

切换用户执行某条命令.

sudo COMMAND.

类似`suid`执行文件属主的身份.

用来定义某个用户能够以另外哪一个用户的身份(可能不是管理员)通过哪些主机执行什么命令.

sudo 执行需要输入密码,防止其他用户执行命令.

sudo 在默认情况下,在第一次输入密码后,会把密码认证信息记录下来,有效期为5分钟.`sudo -k`下次再执行命令无论是否超过5mins,都必须要提供密码.

**sudo的配置文件**

`/etc/sudoers`

这个文件的权限是`440`,避免被其他用户查看.

不建议使用`vim`编译该文件,因为不能检查语法.使用`visudo`专门用来编辑配置文件的`sudoers`命令.这个命令会检查语法的正确性.

每一行定义了一个sudo条目.

**sudo条目的语法格式**

`who`	`which_hosts=(runas)` 	`TAG:` `command`

* `who`: 谁,可以使用`User_Alias`
* `which_hosts`: 在哪些主机,可以使用`Host_Alias`
* `runas`: 以谁的身份,`Runas_Alias`
* `command`: 执行哪些命令,`Cmnd_Alias`
* `TAG`:
	* `NOPASSWD`: 这个标签后的所有命令,用户不需要在输入密码.

可以用`default`关键字定义默认属性.

**sudo别名**

类似定义的`组`.

支持4类别名:

* 用户别名: User_Alias, 多个用户可以定义为一个组,让一个组有这样一个权限.
* 主机别名: Host_Alias
* 用户身份别名: Runas_Alias
* command: Cmnd_Alias, 命令最好使用绝对路径.

别名必须全部而且只能使用大写英文字母的组合.

可以使用`!别名`,表示取反.

用户别名:
 
		User_Alias ALIASNAME = 用户名,组名都可以.组名之前需要加上%.还可以包含其他已经定义的用户别名
		
Host_Alias:

		Host_Alias ALIASNAME = 主机名,IP,网络地址,或者其他主机别名.
		
Runas_Alias:

		用户名
		%组名
		其他的Runas别名
		
Cmnd_Alias:

		命令路径
		目录(此目录内的所有命令)
		其它实现定义过的命令别名				
		
**示例**

`hadoop`用户,以`root`身份执行,`useradd`(无需输入密码)和`usermod`命令(需要输入密码).

		hadoop	ALL=(root)	NOPASSWD: /usr/sbin/useradd, PASSWD: /usr/sbin/usermod	
		
`hadoop`用户,`hadoop`组,`useradmin`组,以`root`身份执行`useradd`,`usermod`,`userdel`,`passwd`命令,但是不能修改`root`密码.		
		
		User_Alias USERADMIN = hadoop, %hadoop, %useradmin
		Cmnd_Alias USERADMINCMND = /usr/sbin/useradd, /usr/sbin/usermod, /usr/sbin/userdel, /usr/bin/passwd [A-Za-z]*, ! /usr/bin/passwd root
		
		USERADMIN	ALL=(root) NOPASSWD: USERADMINCMND
		
`/usr/bin/passwd [A-Za-z]*`(开头大小写字母,后面跟任意字符)这样匹配是因为,`passwd`后面不跟任何参数就是默认修改`root`密码.这样我们让这个命令后面必须跟字符
		
####sudo命令

* `-l`: 列出当前用户可以使用的所有`sudo`类命令
* `-k`: 让认证信息失效
			
####/var/log/secure

sudo 使用过程都会比记录在该日志文件内.
		
		[chloroplast@iZ94jqmwawyZ ~]$ sudo tail /var/log/secure
		Jul 20 11:09:32 iZ94jqmwawyZ sudo: chloroplast : TTY=pts/2 ; PWD=/home/chloroplast ; USER=root ; COMMAND=/bin/tail /var/log/secure
			
###整理知识点

---