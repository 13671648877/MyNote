# 36_01_Linux集群系列之一——集群基础概念

---

## 笔记

---

### LAMP

#### http 

无状态协议, 每个请求都是单独的.

mysql cpu密集型, 需要大量使用cpu时间查询.

网卡是在内核空间, web服务器是在用户空间. 所以一个请求过来需要从内核空间切换到用户空间. 在返回给用户的时候通过网卡, 还需要从用户空间切换到内核空间.

假设条件:

* 200个并发, 其中50个是动态的.
* 使用`prefork`模型.
* 静态的占用 2M 内存, 访问静态页面.
* 动态的占用 10M, 动态请求需要程序执行, 可能还要和数据库交互.

webserver一共需要占用 500M + 150*2M = 800M

一共200个请求, 需要200个IO.

如果请求增多, 有2种解决模式:

* **Scale ON 向上扩展**: 对服务器升级. 硬件的增长比例所带来的性能增长比例不是线性的(假设8G内存,2核CPU升级到16G,8核CPU, 对性能的增长不是4倍).一段区间内增长,后续性能会下降. CPU越多(仲裁策略和分配策略:解决资源竞争的策略,一个请求过来分配给哪个CPU), 如果架构设计不得当性能会下降的.**一定范围内性能提升,成本较高(服务器的价格不是按照提升的倍数来增长的,可能远超于提升的倍数)**
* **Scale OUT 向外扩展**: 通过添加服务器提升处理能力.

#### 负载均衡集群 LB

把请求分散到多台服务器, 叫做**负载均衡(LB)**

* 对DNS添加A记录. 用户对DNS记录有查询缓存. 用户还是会集中在一台服务器.
* 专门的一个主机设备, 根据某种调度算法将请求分散到主机上.
	* Round Robin: 轮调 
	* WRR: 加权轮调

#### 负载均衡数据共享

图片等一些静态文件可以使用`NFS`. 但是程序文件不可以,因为NFS客户端会把读写请求压在一台NFS服务端,`NFS`的并发能力有限.

可以使用`sync`工具.

##### rsync

`copy`工具, 文件同步工具. 实现文件复制.

在每次文件复制之前, 先检索, 只复制不同的文件.

文件内容变化是内核管理的, 如果文件变化需要`rsync`像其他服务器发起同步通知, 需要由内核空间像用户空间发起请求.

使用`rsync+inotify`

##### 当调度器成为瓶颈

* 功能横向切分
* 调度器需要主备, 高可用

#### 高可用集群 HA

主节点像其他节点定时通知心跳信息.

LB集群有高可用能力, 但是不发送心跳信息, 而且需要借助调度器来协调(一台挂了, 需要把请求分发到好的服务器上). 

##### 后端服务器的监控状态检查

LB检测到后端服务器挂了, 而不再把请求分发到后端服务器上.

##### HA 和 LB 的区别

LB用于提升服务的并发承载能力, HA用于提升服务的始终在线能力, 不会因为宕机导致服务不可用.

* HA: High Availability, 高可用
	* 在线时间/(在线时间+故障处理时间) = 可用性
* LB: 并发处理能力

##### 心跳信息

不能使用广播, 要使用多播或者组播.

##### DC节点

集群的事务协调员. 当DC挂了, 重新推送一台新的DC.

#### fencing 隔离

拒绝其中一个节点访问一个资源的机制叫做`fencing`隔离.

* 节点级别隔离: stonith
* 资源级别隔离: 比如: 屏蔽一个主机访问存储设备接口的功能(硬件必须具有设备管理功能).

#### 避免集群分裂

需要有奇数个节点. 必须有仲裁机制来决定哪一半有效哪一半无效. 如果是偶数的就是各占`50%`.

## 整理知识点

---

### NFS 和 本地文件区别

本地文件是**块**级别. `Direct Attached Storage`, 直接附加存储.

* 2个进程位于同一主机写同一个文件, 需要加锁.
* 2个进程位于不同主机写同一个文件, 读写操作都在内核缓冲区, 读写操作都在内存中完成, 过一段时间在同步到硬盘当中. 2个进程在自己主机的内存完成写. 会导致往同一文件写入而文件系统崩溃.

`NFS`是**文件**级别操作(网路传输文件). `Ntework Attached Storage`, 网络附加存储.

* 2个主机同时写一个文件, 第一个主机写, NS服务器会代为施加锁. 如果同时第2个主机在写, 会阻塞第2个主机的写操作.

### 脑裂

在`DAS`中, 第2个主机以为第一个主机挂了, 两者都开始对同一个存储进行写操作就是脑裂. 第2个主机在抢占资源之前, 切断第一个主机的电源. 因为2个主机使用同一个电源交换机, 像电源交换机发送指令切断第一个主机的电源. 这种功能叫做**stonith: Shoot The Other Node In The Head**