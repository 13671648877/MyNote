# traceroute 

---

利用 ICMP 超时消息 (类型`11`).

traceroute 的原理是试图以最小的TTL发出探测包来跟踪数据包到达目标主机所经过的网关,然后监听一个来自网关`ICMP`的应答.

traceroute通过发送小的数据包到目的设备直到其返回,来测量其需要多长时间.一条路径上的每个设备traceroute要测3次.输出结果中包括每次测试的时间(ms)和设备的名称（如有的话）及其IP地址.

**命令**

```shell
traceroute hostname
```

**参数**

* -d 使用Socket层级的排错功能.
* -f 设置第一个检测数据包的存活数值TTL的大小.
* -F 设置勿离断位.
* -g 设置来源路由网关,最多可设置8个.
* -i 使用指定的网络界面送出数据包.
* -I 使用ICMP回应取代UDP资料信息.
* -m 设置检测数据包的最大存活数值TTL的大小.
* -n 直接使用IP地址而非主机名称.
* -p 设置UDP传输协议的通信端口.
* -r 忽略普通的Routing Table,直接将数据包送到远端主机上.
* -s 设置本地主机送出数据包的IP地址.
* -t 设置检测数据包的TOS数值.
* -v 详细显示指令的执行过程.
* -w 设置等待远端主机回报的时间.
* -x 开启或关闭数据包的正确性检验.

**工作原理**

收到目标主机的IP后,首先给目的主机发送一个`TTL=1`的`UDP`数据包,而经过的第一个路由器收到这个数据包以后,就自动把`TTL`减`1`,而`TTL`变为`0`以后,路由器就把这个包给抛弃了,并同时产生一个主机不可达的`ICMP`数据报给主机.

主机收到这个数据报以后再发一个`TTL=2`的`UDP`数据报给目的主机,然后刺激第二个路由器给主机发ICMP数据报.如此往复直到到达目的主机.这样,`traceroute`就拿到了所有的路由器ip.从而避开了ip头只能记录有限路由IP的问题,

==怎么知道UDP到没到达目的主机呢?==,TCP和UDP协议有一个端口号定义,而普通的网络程序只监控少数的几个号码较小的端口,比如说80,比如说23,等等.而traceroute发送的是端口号`>30000`的UDP报,所以到达目的主机的时候,目的主机只能发送一个端口不可达的ICMP数据报给主机.主机接到这个报告以后就知道,主机到了,

**示例**

```shell
traceroute www.dameiwang.cc
traceroute to www.dameiwang.cc (121.199.19.173), 64 hops max, 52 byte packets
 1  192.168.0.1 (192.168.0.1)  1.696 ms  0.900 ms  1.208 ms
 2  219.144.249.1 (219.144.249.1)  8.617 ms  2.880 ms  6.184 ms
 3  10.224.61.5 (10.224.61.5)  20.638 ms
    10.224.61.13 (10.224.61.13)  3.730 ms
    10.224.61.5 (10.224.61.5)  5.125 ms
 4  117.36.240.45 (117.36.240.45)  5.223 ms
    117.36.240.125 (117.36.240.125)  9.932 ms
    117.36.240.53 (117.36.240.53)  5.810 ms
 5  202.97.78.10 (202.97.78.10)  40.902 ms
    202.97.78.222 (202.97.78.222)  33.349 ms  31.241 ms
 6  220.191.200.38 (220.191.200.38)  39.042 ms
    220.191.200.142 (220.191.200.142)  51.531 ms
    220.191.200.78 (220.191.200.78)  37.307 ms
 7  115.236.101.217 (115.236.101.217)  34.539 ms
    115.236.101.221 (115.236.101.221)  31.049 ms
    115.236.101.213 (115.236.101.213)  34.894 ms
 8  42.120.247.73 (42.120.247.73)  33.646 ms
    42.120.247.89 (42.120.247.89)  36.475 ms
    42.120.247.73 (42.120.247.73)  34.427 ms
 9  140.205.27.201 (140.205.27.201)  30.083 ms
    140.205.27.205 (140.205.27.205)  27.881 ms
    140.205.27.213 (140.205.27.213)  40.154 ms
10  * * *
11  121.199.19.173 (121.199.19.173)  34.170 ms  30.820 ms  33.951 ms
```

记录按序列号从1开始,每个记录就是一跳,每跳表示一个网关,每行有`3`个时间,单位是`ms`.探测数据包向每个网关发送三个数据包后,网关响应后返回的时间.

`*` 表示, 可能是防火墙封掉了`ICMP`的返回信息,所以我们得不到什么相关数据包返回数据.