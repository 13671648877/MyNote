# 第一章 分布式架构

---

## 分布式的特点

分布式系统是一个硬件或软件组件分布在不同的网络计算机上, 彼此之间仅仅通过消息传递进行通信和协调的系统.

### 分布式的特征

#### 分布性

分布式系统中的多台计算都会在空间上随意分布, 同时, 机器的分布情况也会随时变动.

#### 对等性

分布式系统中的计算机没有主/从之分, 既没有控制整个系统的主机, 也没有被控制的从机, 组成分布式系统的所有计算机节点都是**对等的**. 副本(Replica)是分布式系统最常见的概念之一, 指的是分布式系统对数据和服务提供的一种**冗余**方式. 为了对外提供高可用的服务, 会对数据和服务进行副本处理.

**数据副本**是指在不同的节点上持久化同一份数据, 当某一个节点上存储的数据丢失时, 可以从副本上读取到该数据, 这是解决分布式系统数据丢失问题最为有效的手段. 

**服务副本**是指多个节点提供同样的服务, 每个节点都有能力接收来自外部的请求并进行相应的处理.

#### 并发性

同一个分布式系统中的多个节点, 可能会**并发地操作一些共享的资源**, 诸如数据库或分布式存储等, **如何准确并高效地协调分布式并发操作**也成为了分布式系统架构与设计中最大的挑战之一. 

#### 缺乏全局时钟

一个典型的分布式系统是由一系列在空间上随意分布的多个进程组成的, 具有明显的分布性, 这些进程之间通过交换消息来进行相互通信. **在分布式系统中, 很难定义两个事件究竟谁先谁后**, 原因就是因为**分布式系统缺乏一个全局的时钟序列控制**.

#### 故障总是会发生

任何设计阶段考虑到的异常情况, 一定会在系统实际运行中发生, 并且, 在系统实际运行过程中还会遇到很多在设计时未能考虑到的异常故障.

### 分布式环境的各种问题

#### 通信异常

* 网络本身的不可靠性.
* 网络的延时性(远远大于单机的内存).

因此消息的丢失和消息延迟变得非常普遍.

#### 网络分区

当网络由于发生异常情况, 导致分布式系统中部分节点之间的网络延时不断增大, 最终导致组成分布式系统的所有节点中, 只有部分节点之间能够进行正常通信, 而另一些节点则不能. 称之为**网络分区(脑裂)**.

#### 三态

分布式系统的每一次请求与相应, 存在特有的**三态**概念.

* 成功
* 失败
* 超时

在传统的单机系统中, 应用程序在调用一个函数之后, 能够得到一个非常明确的响应:

* 成功
* 失败

而在分布式系统中, 由于网络是不可靠的, 虽然在绝大部分情况下, 网络通信也能够接收到成功或失败的影响, 但是当网络出现异常的情况下, 就可能会出现超时现象:

* 由于网络原因, 该请求(消息)并没有被成功地发送到接收方, **在发送过程就发生了消息丢失现象**.
* 该请求(消息)成功的被接收方接收后, 并进行了处理, 但是在**将响应反馈给发送方的过程中, 发生了消息丢失现象**.

#### 节点故障

组成分布式系统的服务器节点出现的宕机或僵死现象.

## 从 ACID 到 CAP/BASE

### ACID

事务(Transaction)是由一系列对系统中数据进行访问与更新的操作所组成的**一个程序执行逻辑单元(Unit)**.

狭义上的事务特指数据库事务.

* 当多个应用程序并发访问数据库时, 事务可以在这些应用程序之间提供一个隔离方法(隔离性), 以防止彼此的操作互相干扰.
* 事务为数据库操作序列提供一个从失败中恢复到正常状态的方法, 同时提供了数据库即使在异常状态下仍能保持数据一致性的方法.

#### 事务特征

* 原子性(`A`tomicity)
* 一致性(`C`onsistency)
* 隔离性(`I`solation)
* 持久性(`D`urability)

#### 原子性

事务的原子性是指事务必须是一个原子的操作序列单元. 事务中包含的各项操作在一次执行过程中, 值允许出现以下两种状态之一:

* 全部成功执行.
* 全部不执行.

任何一项操作失败豆浆导致整个事务失败, 同时其他已经被执行的操作都将被撤销并回滚, 只有所有的操作全部成功, 整个事务才算是成功完成.

#### 一致性

事务的一致性是指事务的执行不能破坏数据库的完整性和一致性, 一个事务在执行之前和执行之后, 数据库都必须处于一致性状态.

**什么是一致**事务执行结果必须是使数据库从一个一致性转变到另一个一致性状态, 因此当数据库只包含成功事务提交的结果时, 就能说数据库处于一致性状态.

**什么是不一致**数据库系统在运行过程中发生故障, 有些事务尚未完成就被迫中断, 这些未完成的事务对数据库所做的修改有一部分已经写入物理数据库, 这时数据处于一种不正确的状态, 或者说是不一致状态.

#### 隔离性

#### 持久性

### 分布式事务

### CAP 和 BASE 理论



