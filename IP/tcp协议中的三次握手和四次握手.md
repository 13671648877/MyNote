# TCP协议中的三次握手和四次握手

---


## 名词解释

`URG`: Urget pointer is valid (紧急指针字段值有效)  
`SYN`: 表示建立连接  
`FIN`: 表示关闭连接  
`ACK`: 表示响应  
`PSH`: 表示有DATA数据传输  
`RST`: 表示连接重置

## 三次握手

![握手](./img/1.gif "握手")

**建立连接**

![建立连接](./img/2.gif "建立连接")

1. Client端发送连接请求报文
2. Server段接受连接后回复ACK报文,并为这次连接分配资源
3. Client端接收到ACK报文后也向Server段发生ACK报文,并分配资源

## 四次挥手

**断开连接**

![断开连接](./img/3.gif "断开连接")

1. Client端发起中断连接请求,发送FIN报文
2. Server端接到FIN报文后,意思是说"我Client端没有数据要发给你了",但是如果你还有数据没有发送完成,则不必急着关闭Socket,可以继续发送数据.所以你先发送ACK,"告诉Client端,你的请求我收到了,但是我还没准备好,请继续你等我的消息"
3. 这个时候Client端就进入FIN_WAIT状态,继续等待Server端的FIN报文
4. 当Server端确定数据已发送完成,则向Client端发送FIN报文,"告诉Client端，好了，我这边数据发完了，准备好关闭连接了".
5. Client端收到FIN报文后,"就知道可以关闭连接了，但是他还是不相信网络，怕Server端不知道要关闭，所以发送ACK后进入TIME_WAIT状态，如果Server端没有收到ACK则可以重传.
6. Server端收到ACK后,"就知道可以断开连接了".
7. Client端等待了2MSL后依然没有收到回复,则证明Server端已正常关闭,那好,我Client端也可以关闭连接了.

**为什么TIME_WAIT状态还需要等2MSL后才能返回到CLOSED状态**

这是因为虽然双方都同意关闭连接了,而且握手的4个报文也都协调和发送完毕,按理可以直接回到CLOSED状态.但是因为我们必须要假想网络是不可靠的,你`无法保证你最后发送的ACK报文会一定被对方收到`,因此对方处于LAST_ACK状态下的SOCKET可能会因为超时未收到ACK报文,而`重发FIN报文`,所以这个TIME_WAIT状态的作用就是用来重发可能丢失的ACK报文.